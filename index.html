<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>ìš¸íƒ€ë¦¬ ì¸¡ëŸ‰</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@7.3.0/ol.css">
<style>
  :root {
    --bg: #0a0f1a; --surface: #111827; --surface2: #1a2333;
    --border: #2a3a55; --accent: #00d4aa; --accent2: #3b82f6;
    --danger: #ef4444; --text: #e2e8f0; --text2: #94a3b8; --radius: 12px;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
  html, body { height: 100%; overflow: hidden; font-family: 'Noto Sans KR', sans-serif; background: var(--bg); color: var(--text); }
  #app { display: flex; flex-direction: column; height: 100dvh; }

  header {
    background: var(--surface); border-bottom: 1px solid var(--border);
    padding: 0 10px; display: flex; align-items: center;
    flex-shrink: 0; height: 48px; gap: 8px; z-index: 100;
  }
  .logo { font-size: 14px; font-weight: 900; color: var(--accent); white-space: nowrap; }
  .logo span { color: var(--text2); font-weight: 400; }
  #search-wrap { flex: 1; display: flex; gap: 4px; }
  #search-input {
    flex: 1; background: var(--surface2); border: 1px solid var(--border);
    border-radius: 8px; color: var(--text); font-size: 13px;
    font-family: 'Noto Sans KR', sans-serif; padding: 7px 10px; outline: none;
  }
  #search-input::placeholder { color: var(--text2); }
  #search-input:focus { border-color: var(--accent); }
  #search-btn {
    background: var(--accent2); border: none; border-radius: 8px;
    color: white; padding: 7px 10px; font-size: 13px; cursor: pointer;
    font-family: 'Noto Sans KR', sans-serif; font-weight: 700; white-space: nowrap;
  }
  #gps-status { display: flex; align-items: center; gap: 4px; font-size: 11px; color: var(--text2); white-space: nowrap; }
  .dot { width: 7px; height: 7px; border-radius: 50%; background: var(--text2); flex-shrink: 0; }
  .dot.active { background: var(--accent); animation: pulse 1.5s infinite; }
  .dot.error { background: var(--danger); }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.4} }

  #search-results {
    position: fixed; top: 48px; left: 0; right: 0;
    background: var(--surface); border-bottom: 1px solid var(--border);
    z-index: 200; display: none; max-height: 220px; overflow-y: auto;
  }
  .search-item { padding: 11px 14px; border-bottom: 1px solid var(--border); cursor: pointer; font-size: 13px; }
  .search-item:last-child { border-bottom: none; }
  .search-item .addr { font-size: 11px; color: var(--text2); margin-top: 2px; }
  .search-empty { padding: 14px; color: var(--text2); font-size: 13px; text-align: center; }

  #map { flex: 1; position: relative; min-height: 0; }
  #ol-map { width: 100%; height: 100%; }

  #loading-overlay {
    position: absolute; inset: 0; background: var(--bg);
    display: flex; align-items: center; justify-content: center;
    flex-direction: column; gap: 12px; z-index: 50;
  }
  .spinner { width: 36px; height: 36px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }

  #stats-overlay {
    position: absolute; top: 8px; left: 8px; z-index: 10;
    display: flex; flex-direction: column; gap: 5px; pointer-events: none;
  }
  .stat-chip {
    background: rgba(10,15,26,0.9); border: 1px solid var(--border);
    border-radius: 8px; padding: 5px 10px; font-size: 12px;
    font-family: 'JetBrains Mono', monospace; backdrop-filter: blur(6px);
  }
  .stat-chip .lbl { color: var(--text2); font-size: 10px; }
  .stat-chip .val { color: var(--accent); font-weight: 700; }

  #map-controls { position: absolute; top: 8px; right: 8px; z-index: 10; display: flex; flex-direction: column; gap: 6px; }
  .map-btn {
    background: rgba(10,15,26,0.9); border: 1px solid var(--border);
    border-radius: 8px; padding: 7px 10px; font-size: 12px;
    color: var(--text2); cursor: pointer; backdrop-filter: blur(6px);
    font-family: 'Noto Sans KR', sans-serif; font-weight: 700; white-space: nowrap;
  }
  .map-btn:active { opacity: 0.7; }

  #fab-mark {
    position: absolute; bottom: 14px; left: 50%; transform: translateX(-50%);
    background: var(--accent); color: #0a0f1a; border: none; border-radius: 50px;
    padding: 14px 28px; font-size: 15px; font-weight: 900;
    font-family: 'Noto Sans KR', sans-serif;
    box-shadow: 0 4px 20px rgba(0,212,170,0.4);
    cursor: pointer; z-index: 10; white-space: nowrap; transition: all 0.15s;
  }
  #fab-mark:disabled { background: #2a3a55; color: var(--text2); box-shadow: none; }
  #fab-mark:active:not(:disabled) { transform: translateX(-50%) scale(0.96); }

  #bottom-panel { background: var(--surface); border-top: 1px solid var(--border); flex-shrink: 0; }
  #panel-toggle { width: 100%; background: none; border: none; color: var(--text2); font-size: 12px; font-family: 'Noto Sans KR', sans-serif; padding: 8px; cursor: pointer; }
  #panel-content { padding: 10px 12px; display: none; }
  .btn-row { display: grid; grid-template-columns: 1fr 1fr; gap: 7px; margin-bottom: 7px; }
  .act { border: none; border-radius: var(--radius); font-family: 'Noto Sans KR', sans-serif; font-weight: 700; cursor: pointer; padding: 11px; font-size: 13px; display: flex; align-items: center; justify-content: center; gap: 4px; }
  .act:active { opacity: 0.7; }
  #btn-calc { background: var(--surface2); border: 1px solid var(--accent2) !important; color: var(--accent2); }
  #btn-undo { background: var(--surface2); border: 1px solid var(--border) !important; color: var(--text2); }
  #btn-reset { background: var(--surface2); border: 1px solid var(--danger) !important; color: var(--danger); grid-column: 1/-1; }
  #points-scroll { max-height: 65px; overflow-y: auto; display: flex; flex-direction: column; gap: 3px; margin-top: 7px; }
  .point-item { background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; padding: 4px 8px; font-size: 11px; font-family: 'JetBrains Mono', monospace; color: var(--text2); display: flex; align-items: center; gap: 6px; }
  .point-num { background: var(--accent); color: #0a0f1a; width: 16px; height: 16px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 9px; font-weight: 700; flex-shrink: 0; }

  #toast { position: fixed; top: 58px; left: 50%; transform: translateX(-50%) translateY(-10px); background: var(--surface); border: 1px solid var(--accent); color: var(--accent); padding: 8px 18px; border-radius: 99px; font-size: 13px; font-weight: 700; opacity: 0; transition: all 0.25s; z-index: 999; white-space: nowrap; pointer-events: none; }
  #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
  #toast.error { border-color: var(--danger); color: var(--danger); }

  #result-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 500; align-items: center; justify-content: center; padding: 20px; }
  #result-modal.show { display: flex; }
  .modal-box { background: var(--surface); border: 1px solid var(--accent); border-radius: 20px; padding: 26px 22px; width: 100%; max-width: 340px; text-align: center; }
  .modal-title { font-size: 14px; color: var(--text2); margin-bottom: 8px; }
  .modal-area { font-size: 34px; font-weight: 900; color: var(--accent); font-family: 'JetBrains Mono', monospace; line-height: 1.1; margin-bottom: 4px; }
  .modal-pyeong { font-size: 16px; color: var(--text2); margin-bottom: 18px; }
  .modal-points { text-align: left; background: var(--surface2); border-radius: 10px; padding: 10px; margin-bottom: 18px; max-height: 140px; overflow-y: auto; }
  .modal-point-row { font-size: 11px; font-family: 'JetBrains Mono', monospace; color: var(--text2); padding: 3px 0; border-bottom: 1px solid var(--border); }
  .modal-point-row:last-child { border-bottom: none; }
  .modal-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  .mbtn { padding: 12px; font-size: 13px; border-radius: 10px; cursor: pointer; font-family: 'Noto Sans KR', sans-serif; font-weight: 700; border: none; }
  .mbtn-close { background: var(--surface2); color: var(--text2); }
  .mbtn-new { background: var(--accent); color: #0a0f1a; }

  .ol-zoom, .ol-rotate { display: none !important; }
  .ol-attribution { font-size: 9px !important; }
</style>
</head>
<body>
<div id="app">
  <header>
    <div class="logo">ì¸¡ëŸ‰<span>GPS</span></div>
    <div id="search-wrap">
      <input id="search-input" type="text" placeholder="ì£¼ì†Œ ë˜ëŠ” ì§€ëª… ê²€ìƒ‰" autocomplete="off">
      <button id="search-btn">ê²€ìƒ‰</button>
    </div>
    <div id="gps-status">
      <div class="dot" id="gps-dot"></div>
      <span id="gps-text">ëŒ€ê¸°ì¤‘</span>
    </div>
  </header>

  <div id="search-results"></div>

  <div id="map">
    <div id="ol-map"></div>
    <div id="loading-overlay">
      <div class="spinner"></div>
      <div style="color:var(--text2);font-size:13px">ì§€ë„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>
    <div id="stats-overlay">
      <div class="stat-chip">
        <div class="lbl">ì°ì€ ì </div>
        <div class="val"><span id="stat-points">0</span> ê°œ</div>
      </div>
      <div class="stat-chip" id="chip-area" style="display:none">
        <div class="lbl">ë©´ì </div>
        <div class="val"><span id="stat-area">-</span> ã¡</div>
        <div class="val"><span id="stat-pyeong">-</span> í‰</div>
      </div>
    </div>
    <div id="map-controls">
      <button class="map-btn" id="layer-toggle">ğŸ—º ì§€ì ë„ ON</button>
      <button class="map-btn" id="btn-myloc">ğŸ“ ë‚´ìœ„ì¹˜</button>
    </div>
    <button id="fab-mark" disabled>ğŸ“ í˜„ì¬ ìœ„ì¹˜ ì°ê¸°</button>
  </div>

  <div id="bottom-panel">
    <button id="panel-toggle">â–² ë„êµ¬ ë©”ë‰´ ì—´ê¸°</button>
    <div id="panel-content">
      <div class="btn-row">
        <button class="act" id="btn-calc">ğŸ”’ ë©´ì  ê³„ì‚°</button>
        <button class="act" id="btn-undo">â†© ë§ˆì§€ë§‰ ì‚­ì œ</button>
      </div>
      <div class="btn-row">
        <button class="act" id="btn-reset">ğŸ—‘ ì „ì²´ ì´ˆê¸°í™”</button>
      </div>
      <div id="points-scroll"></div>
    </div>
  </div>
</div>

<div id="toast"></div>
<div id="result-modal">
  <div class="modal-box">
    <div class="modal-title">ğŸ“ ìš¸íƒ€ë¦¬ ì¸¡ëŸ‰ ê²°ê³¼</div>
    <div class="modal-area" id="modal-area-val"></div>
    <div class="modal-pyeong" id="modal-pyeong-val"></div>
    <div class="modal-points" id="modal-points-list"></div>
    <div class="modal-btns">
      <button class="mbtn mbtn-close" id="modal-close-btn">ë‹«ê¸°</button>
      <button class="mbtn mbtn-new" id="modal-new-btn">ìƒˆ ì¸¡ëŸ‰</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/ol@7.3.0/dist/ol.js"></script>
<script>
const API_KEY = '2699662E-B096-31F3-9157-CB9AE0DEA5A7';

// â”€â”€ JSONP ê²€ìƒ‰ (CORS ìš°íšŒ) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _searchCb = null;
function searchJSONP(query, type, callback) {
  const cbName = '_vwCb_' + Date.now();
  const old = document.getElementById('_vw_jsonp');
  if (old) old.remove();
  window[cbName] = function(data) {
    delete window[cbName];
    callback(data);
  };
  const url = 'https://api.vworld.kr/req/search?service=search&request=search&version=2.0'
    + '&crs=EPSG:4326&size=5&page=1'
    + '&query=' + encodeURIComponent(query)
    + '&type=' + type
    + '&format=json&errorFormat=json'
    + '&callback=' + cbName
    + '&key=' + API_KEY;
  const s = document.createElement('script');
  s.id = '_vw_jsonp';
  s.src = url;
  s.onerror = function() { callback(null); };
  document.head.appendChild(s);
}

window.addEventListener('load', function() {
  if (typeof ol === 'undefined') {
    document.getElementById('loading-overlay').innerHTML =
      '<div style="color:var(--danger);padding:20px;text-align:center">ì§€ë„ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì‹¤íŒ¨.<br>ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.</div>';
    return;
  }
  initApp();
});

function initApp() {
  let points = [];
  let currentPos = null;
  let panelOpen = false;
  let cadastralOn = true;
  let myLocFeature = null;
  let shapeFeature = null;
  let firstFix = true;

  // â”€â”€ ì§€ë„ ë ˆì´ì–´ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const baseLayer = new ol.layer.Tile({
    source: new ol.source.XYZ({
      url: 'https://api.vworld.kr/req/wmts/1.0.0/' + API_KEY + '/Satellite/{z}/{y}/{x}.jpeg',
      crossOrigin: 'anonymous',
      maxZoom: 19
    })
  });

  // ì§€ì ë„: WMTS ë°©ì‹ (WMSë³´ë‹¤ ì•ˆì •ì )
  const cadastralLayer = new ol.layer.Tile({
    source: new ol.source.XYZ({
      url: 'https://api.vworld.kr/req/wmts/1.0.0/' + API_KEY + '/lp/{z}/{y}/{x}.png',
      crossOrigin: 'anonymous',
      maxZoom: 19
    }),
    opacity: 0.8,
    visible: true
  });

  const vectorSource = new ol.source.Vector();
  const vectorLayer = new ol.layer.Vector({ source: vectorSource, zIndex: 10 });

  const map = new ol.Map({
    target: 'ol-map',
    layers: [baseLayer, cadastralLayer, vectorLayer],
    view: new ol.View({
      center: ol.proj.fromLonLat([127.5, 36.5]),
      zoom: 7, minZoom: 6, maxZoom: 20
    }),
    controls: ol.control.defaults.defaults({ zoom: false, attribution: false })
  });

  document.getElementById('loading-overlay').style.display = 'none';

  // ìŠ¤íƒ€ì¼
  function makeMarkerStyle(num) {
    return new ol.style.Style({
      image: new ol.style.Circle({
        radius: 9,
        fill: new ol.style.Fill({ color: '#00d4aa' }),
        stroke: new ol.style.Stroke({ color: '#fff', width: 2 })
      }),
      text: new ol.style.Text({
        text: String(num),
        fill: new ol.style.Fill({ color: '#0a0f1a' }),
        font: 'bold 10px sans-serif'
      })
    });
  }

  const myLocStyle = new ol.style.Style({
    image: new ol.style.Circle({
      radius: 10,
      fill: new ol.style.Fill({ color: 'rgba(59,130,246,0.85)' }),
      stroke: new ol.style.Stroke({ color: '#fff', width: 2.5 })
    })
  });

  // â”€â”€ ì§€ì ë„ í† ê¸€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('layer-toggle').addEventListener('click', function() {
    cadastralOn = !cadastralOn;
    cadastralLayer.setVisible(cadastralOn);
    this.textContent = cadastralOn ? 'ğŸ—º ì§€ì ë„ ON' : 'ğŸ—º ì§€ì ë„ OFF';
  });

  // â”€â”€ GPS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function startGPS() {
    const dot = document.getElementById('gps-dot');
    const txt = document.getElementById('gps-text');
    if (!navigator.geolocation) { dot.className = 'dot error'; txt.textContent = 'ë¯¸ì§€ì›'; return; }
    navigator.geolocation.watchPosition(function(pos) {
      currentPos = { lat: pos.coords.latitude, lng: pos.coords.longitude, acc: pos.coords.accuracy };
      dot.className = 'dot active';
      txt.textContent = 'Â±' + Math.round(pos.coords.accuracy) + 'm';
      document.getElementById('fab-mark').disabled = false;
      const coord = ol.proj.fromLonLat([currentPos.lng, currentPos.lat]);
      if (!myLocFeature) {
        myLocFeature = new ol.Feature(new ol.geom.Point(coord));
        myLocFeature.setStyle(myLocStyle);
        vectorSource.addFeature(myLocFeature);
      } else {
        myLocFeature.getGeometry().setCoordinates(coord);
      }
      if (firstFix) {
        firstFix = false;
        map.getView().animate({ center: coord, zoom: 18, duration: 1000 });
      }
    }, function() {
      dot.className = 'dot error';
      txt.textContent = 'ì˜¤ë¥˜';
      showToast('GPS ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”', true);
    }, { enableHighAccuracy: true, maximumAge: 3000, timeout: 20000 });
  }

  document.getElementById('btn-myloc').addEventListener('click', function() {
    if (!currentPos) { showToast('GPS ì‹ í˜¸ ëŒ€ê¸°ì¤‘...', true); return; }
    map.getView().animate({ center: ol.proj.fromLonLat([currentPos.lng, currentPos.lat]), zoom: 18, duration: 600 });
  });

  // â”€â”€ ìœ„ì¹˜ ì°ê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('fab-mark').addEventListener('click', function() {
    if (!currentPos) { showToast('GPS ì‹ í˜¸ ëŒ€ê¸°ì¤‘...', true); return; }
    const p = { lat: currentPos.lat, lng: currentPos.lng, acc: currentPos.acc, id: points.length + 1 };
    points.push(p);
    const f = new ol.Feature(new ol.geom.Point(ol.proj.fromLonLat([p.lng, p.lat])));
    f.setStyle(makeMarkerStyle(p.id));
    vectorSource.addFeature(f);
    p._feature = f;
    redrawShape();
    updateUI();
    showToast('ğŸ“ ' + points.length + 'ë²ˆ ì  ì €ì¥! (Â±' + Math.round(currentPos.acc) + 'm)');
  });

  function redrawShape() {
    if (shapeFeature) { vectorSource.removeFeature(shapeFeature); shapeFeature = null; }
    if (points.length < 2) return;
    const coords = points.map(function(p) { return ol.proj.fromLonLat([p.lng, p.lat]); });
    if (points.length >= 3) {
      shapeFeature = new ol.Feature(new ol.geom.Polygon([[...coords, coords[0]]]));
      shapeFeature.setStyle(new ol.style.Style({
        fill: new ol.style.Fill({ color: 'rgba(0,212,170,0.12)' }),
        stroke: new ol.style.Stroke({ color: '#00d4aa', width: 2 })
      }));
    } else {
      shapeFeature = new ol.Feature(new ol.geom.LineString(coords));
      shapeFeature.setStyle(new ol.style.Style({
        stroke: new ol.style.Stroke({ color: '#00d4aa', width: 2, lineDash: [6,4] })
      }));
    }
    vectorSource.addFeature(shapeFeature);
  }

  // â”€â”€ ê²€ìƒ‰ (JSONP) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('search-btn').addEventListener('click', doSearch);
  document.getElementById('search-input').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') doSearch();
  });

  function doSearch() {
    const q = document.getElementById('search-input').value.trim();
    if (!q) return;
    const div = document.getElementById('search-results');
    div.innerHTML = '<div class="search-empty">ê²€ìƒ‰ì¤‘...</div>';
    div.style.display = 'block';

    searchJSONP(q, 'PLACE', function(data) {
      const items = data && data.response && data.response.result && data.response.result.items
        ? data.response.result.items : [];
      if (!items.length) {
        // ì£¼ì†Œë¡œ ì¬ê²€ìƒ‰
        searchJSONP(q, 'ADDRESS', function(data2) {
          const items2 = data2 && data2.response && data2.response.result && data2.response.result.items
            ? data2.response.result.items : [];
          renderResults(items2);
        });
      } else {
        renderResults(items);
      }
    });
  }

  function renderResults(items) {
    const div = document.getElementById('search-results');
    if (!items || !items.length) {
      div.innerHTML = '<div class="search-empty">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
      return;
    }
    div.innerHTML = items.map(function(item, i) {
      const name = item.title || '';
      const addr = (item.address && (item.address.road || item.address.parcel)) || '';
      const x = item.point && item.point.x ? item.point.x : null;
      const y = item.point && item.point.y ? item.point.y : null;
      if (!x || !y) return '';
      return '<div class="search-item" data-x="' + x + '" data-y="' + y + '">'
        + '<div>' + name + '</div>'
        + '<div class="addr">' + addr + '</div>'
        + '</div>';
    }).join('');
    div.querySelectorAll('.search-item').forEach(function(el) {
      el.addEventListener('click', function() {
        const x = parseFloat(this.dataset.x);
        const y = parseFloat(this.dataset.y);
        map.getView().animate({ center: ol.proj.fromLonLat([x, y]), zoom: 18, duration: 600 });
        div.style.display = 'none';
        document.getElementById('search-input').value = '';
        document.getElementById('search-input').blur();
      });
    });
  }

  document.addEventListener('click', function(e) {
    if (!e.target.closest('#search-wrap') && !e.target.closest('#search-results')) {
      document.getElementById('search-results').style.display = 'none';
    }
  });

  // â”€â”€ ë„êµ¬ ë²„íŠ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('panel-toggle').addEventListener('click', function() {
    panelOpen = !panelOpen;
    document.getElementById('panel-content').style.display = panelOpen ? 'block' : 'none';
    this.textContent = panelOpen ? 'â–¼ ë„êµ¬ ë©”ë‰´ ë‹«ê¸°' : 'â–² ë„êµ¬ ë©”ë‰´ ì—´ê¸°';
  });

  document.getElementById('btn-calc').addEventListener('click', function() {
    if (points.length < 3) { showToast('ìµœì†Œ 3ê°œ ì ì´ í•„ìš”í•©ë‹ˆë‹¤', true); return; }
    showResult(calcArea(points));
  });

  document.getElementById('btn-undo').addEventListener('click', function() {
    if (!points.length) return;
    const last = points.pop();
    if (last._feature) vectorSource.removeFeature(last._feature);
    redrawShape();
    updateUI();
    showToast('ë§ˆì§€ë§‰ ì  ì‚­ì œë¨');
  });

  document.getElementById('btn-reset').addEventListener('click', function() {
    if (!points.length) return;
    if (confirm('ëª¨ë“  ì¸¡ëŸ‰ ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”?')) resetAll();
  });

  document.getElementById('modal-close-btn').addEventListener('click', closeModal);
  document.getElementById('modal-new-btn').addEventListener('click', resetAll);

  function resetAll() {
    points.forEach(function(p) { if (p._feature) vectorSource.removeFeature(p._feature); });
    if (shapeFeature) { vectorSource.removeFeature(shapeFeature); shapeFeature = null; }
    points = [];
    updateUI();
    closeModal();
    showToast('ì´ˆê¸°í™” ì™„ë£Œ');
  }

  // â”€â”€ ë©´ì  ê³„ì‚° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function calcArea(pts) {
    if (pts.length < 3) return 0;
    const R = 6371000;
    const toRad = function(d) { return d * Math.PI / 180; };
    let area = 0;
    const n = pts.length;
    for (let i = 0; i < n; i++) {
      const j = (i + 1) % n;
      const xi = toRad(pts[i].lng) * Math.cos(toRad(pts[i].lat));
      const yi = toRad(pts[i].lat);
      const xj = toRad(pts[j].lng) * Math.cos(toRad(pts[j].lat));
      const yj = toRad(pts[j].lat);
      area += (xi * yj - xj * yi);
    }
    return Math.abs(area / 2) * R * R;
  }

  // â”€â”€ UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function updateUI() {
    document.getElementById('stat-points').textContent = points.length;
    const chipArea = document.getElementById('chip-area');
    if (points.length >= 3) {
      const area = calcArea(points);
      document.getElementById('stat-area').textContent = area.toFixed(1);
      document.getElementById('stat-pyeong').textContent = (area / 3.305785).toFixed(1);
      chipArea.style.display = 'block';
    } else {
      chipArea.style.display = 'none';
    }
    const scroll = document.getElementById('points-scroll');
    scroll.innerHTML = points.map(function(p) {
      return '<div class="point-item">'
        + '<div class="point-num">' + p.id + '</div>'
        + '<span>' + p.lat.toFixed(6) + ', ' + p.lng.toFixed(6) + '</span>'
        + '<span style="margin-left:auto;font-size:10px">Â±' + Math.round(p.acc) + 'm</span>'
        + '</div>';
    }).join('');
    scroll.scrollTop = scroll.scrollHeight;
  }

  function showResult(area) {
    const pyeong = area / 3.305785;
    document.getElementById('modal-area-val').textContent = area.toFixed(2) + ' ã¡';
    document.getElementById('modal-pyeong-val').textContent = pyeong.toFixed(2) + ' í‰';
    document.getElementById('modal-points-list').innerHTML =
      points.map(function(p) {
        return '<div class="modal-point-row">P' + p.id + ': ' + p.lat.toFixed(7) + ', ' + p.lng.toFixed(7) + '</div>';
      }).join('');
    document.getElementById('result-modal').classList.add('show');
  }

  function closeModal() { document.getElementById('result-modal').classList.remove('show'); }

  let toastTimer;
  function showToast(msg, isError) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.className = 'show' + (isError ? ' error' : '');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(function() { t.className = ''; }, 2500);
  }

  startGPS();
}
</script>
</body>
</html>
