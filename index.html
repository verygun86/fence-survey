<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>ìš¸íƒ€ë¦¬ ì¸¡ëŸ‰</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0f1a; --surface: #111827; --surface2: #1a2333;
    --border: #2a3a55; --accent: #00d4aa; --accent2: #3b82f6;
    --danger: #ef4444; --warn: #f59e0b; --text: #e2e8f0; --text2: #94a3b8; --radius: 12px;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
  html, body { height: 100%; overflow: hidden; font-family: 'Noto Sans KR', sans-serif; background: var(--bg); color: var(--text); }
  #app { display: flex; flex-direction: column; height: 100dvh; }

  header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 0 10px; display: flex; align-items: center; flex-shrink: 0; height: 48px; gap: 8px; z-index: 100; }
  .logo { font-size: 14px; font-weight: 900; color: var(--accent); white-space: nowrap; }
  .logo span { color: var(--text2); font-weight: 400; }
  #search-wrap { flex: 1; display: flex; gap: 4px; }
  #search-input { flex: 1; background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 13px; font-family: 'Noto Sans KR', sans-serif; padding: 7px 10px; outline: none; }
  #search-input::placeholder { color: var(--text2); }
  #search-input:focus { border-color: var(--accent); }
  #search-btn { background: var(--accent2); border: none; border-radius: 8px; color: white; padding: 7px 10px; font-size: 13px; cursor: pointer; font-family: 'Noto Sans KR', sans-serif; font-weight: 700; white-space: nowrap; }
  #gps-status { display: flex; align-items: center; gap: 4px; font-size: 11px; color: var(--text2); white-space: nowrap; }
  .dot { width: 7px; height: 7px; border-radius: 50%; background: var(--text2); flex-shrink: 0; }
  .dot.active { background: var(--accent); animation: pulse 1.5s infinite; }
  .dot.error { background: var(--danger); }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.4} }

  #search-results { position: fixed; top: 48px; left: 0; right: 0; background: var(--surface); border-bottom: 1px solid var(--border); z-index: 200; display: none; max-height: 220px; overflow-y: auto; }
  .search-item { padding: 11px 14px; border-bottom: 1px solid var(--border); cursor: pointer; font-size: 13px; }
  .search-item:last-child { border-bottom: none; }
  .search-item .addr { font-size: 11px; color: var(--text2); margin-top: 2px; }
  .search-empty { padding: 14px; color: var(--text2); font-size: 13px; text-align: center; }

  #map { flex: 1; position: relative; min-height: 0; }
  #kakao-map { width: 100%; height: 100%; }

  /* ëª¨ë“œ ì „í™˜ íƒ­ */
  #mode-bar {
    position: absolute; top: 8px; left: 50%; transform: translateX(-50%);
    z-index: 10; background: rgba(10,15,26,0.95); border: 1px solid var(--border);
    border-radius: 10px; display: flex; overflow: hidden; backdrop-filter: blur(6px);
  }
  .mode-btn {
    padding: 7px 14px; font-size: 12px; font-weight: 700;
    font-family: 'Noto Sans KR', sans-serif; border: none; cursor: pointer;
    background: transparent; color: var(--text2); transition: all 0.2s; white-space: nowrap;
  }
  .mode-btn.active { background: var(--accent); color: #0a0f1a; }

  #stats-overlay { position: absolute; top: 48px; left: 8px; z-index: 10; display: flex; flex-direction: column; gap: 5px; pointer-events: none; margin-top: 4px; }
  .stat-chip { background: rgba(10,15,26,0.92); border: 1px solid var(--border); border-radius: 8px; padding: 5px 10px; font-size: 12px; font-family: 'JetBrains Mono', monospace; backdrop-filter: blur(6px); }
  .stat-chip .lbl { color: var(--text2); font-size: 10px; }
  .stat-chip .val { color: var(--accent); font-weight: 700; }
  .stat-chip .val.warn { color: var(--warn); }

  #map-controls { position: absolute; top: 48px; right: 8px; z-index: 10; display: flex; flex-direction: column; gap: 6px; margin-top: 4px; }
  .map-btn { background: rgba(10,15,26,0.92); border: 1px solid var(--border); border-radius: 8px; padding: 7px 10px; font-size: 12px; color: var(--text2); cursor: pointer; backdrop-filter: blur(6px); font-family: 'Noto Sans KR', sans-serif; font-weight: 700; white-space: nowrap; }
  .map-btn.on { border-color: var(--accent); color: var(--accent); }
  .map-btn:active { opacity: 0.7; }

  /* ì¤Œ ë²„íŠ¼ */
  #zoom-controls { position: absolute; bottom: 80px; right: 12px; z-index: 10; display: flex; flex-direction: column; gap: 4px; }
  .zoom-btn { width: 38px; height: 38px; background: rgba(10,15,26,0.92); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(6px); }
  .zoom-btn:active { opacity: 0.7; }

  /* FAB - GPS ëª¨ë“œ */
  #fab-gps {
    position: absolute; bottom: 14px; left: 50%; transform: translateX(-50%);
    background: var(--accent); color: #0a0f1a; border: none; border-radius: 50px;
    padding: 14px 24px; font-size: 15px; font-weight: 900;
    font-family: 'Noto Sans KR', sans-serif; box-shadow: 0 4px 20px rgba(0,212,170,0.4);
    cursor: pointer; z-index: 10; white-space: nowrap; transition: all 0.15s;
  }
  #fab-gps:disabled { background: #2a3a55; color: var(--text2); box-shadow: none; }
  #fab-gps:active:not(:disabled) { transform: translateX(-50%) scale(0.96); }

  /* í„°ì¹˜ ëª¨ë“œ ì•ˆë‚´ */
  #touch-hint {
    position: absolute; bottom: 14px; left: 50%; transform: translateX(-50%);
    background: rgba(245,158,11,0.15); border: 1px solid var(--warn);
    color: var(--warn); border-radius: 50px; padding: 10px 20px;
    font-size: 13px; font-weight: 700; font-family: 'Noto Sans KR', sans-serif;
    z-index: 10; white-space: nowrap; display: none; text-align: center;
  }

  #bottom-panel { background: var(--surface); border-top: 1px solid var(--border); flex-shrink: 0; }
  #panel-toggle { width: 100%; background: none; border: none; color: var(--text2); font-size: 12px; font-family: 'Noto Sans KR', sans-serif; padding: 8px; cursor: pointer; }
  #panel-content { padding: 10px 12px; display: none; }
  .btn-row { display: grid; grid-template-columns: 1fr 1fr; gap: 7px; margin-bottom: 7px; }
  .act { border: none; border-radius: var(--radius); font-family: 'Noto Sans KR', sans-serif; font-weight: 700; cursor: pointer; padding: 11px; font-size: 13px; display: flex; align-items: center; justify-content: center; gap: 4px; }
  .act:active { opacity: 0.7; }
  #btn-calc { background: var(--surface2); border: 1px solid var(--accent2) !important; color: var(--accent2); }
  #btn-undo { background: var(--surface2); border: 1px solid var(--border) !important; color: var(--text2); }
  #btn-reset { background: var(--surface2); border: 1px solid var(--danger) !important; color: var(--danger); grid-column: 1/-1; }
  #points-scroll { max-height: 65px; overflow-y: auto; display: flex; flex-direction: column; gap: 3px; margin-top: 7px; }
  .point-item { background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; padding: 4px 8px; font-size: 11px; font-family: 'JetBrains Mono', monospace; color: var(--text2); display: flex; align-items: center; gap: 6px; }
  .point-num { width: 16px; height: 16px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 9px; font-weight: 700; flex-shrink: 0; }
  .point-num.gps { background: var(--accent); color: #0a0f1a; }
  .point-num.touch { background: var(--warn); color: #0a0f1a; }

  #toast { position: fixed; top: 58px; left: 50%; transform: translateX(-50%) translateY(-10px); background: var(--surface); border: 1px solid var(--accent); color: var(--accent); padding: 8px 18px; border-radius: 99px; font-size: 13px; font-weight: 700; opacity: 0; transition: all 0.25s; z-index: 999; white-space: nowrap; pointer-events: none; }
  #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
  #toast.error { border-color: var(--danger); color: var(--danger); }
  #toast.warn { border-color: var(--warn); color: var(--warn); }

  #result-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 500; align-items: center; justify-content: center; padding: 20px; }
  #result-modal.show { display: flex; }
  .modal-box { background: var(--surface); border: 1px solid var(--accent); border-radius: 20px; padding: 22px 18px; width: 100%; max-width: 340px; text-align: center; }
  .modal-title { font-size: 14px; color: var(--text2); margin-bottom: 8px; }
  .modal-area { font-size: 30px; font-weight: 900; color: var(--accent); font-family: 'JetBrains Mono', monospace; line-height: 1.1; margin-bottom: 2px; }
  .modal-sub { font-size: 14px; color: var(--text2); margin-bottom: 6px; }
  .modal-dist { font-size: 16px; font-weight: 700; color: var(--accent2); margin-bottom: 14px; }
  .modal-points { text-align: left; background: var(--surface2); border-radius: 10px; padding: 10px; margin-bottom: 14px; max-height: 130px; overflow-y: auto; }
  .modal-point-row { font-size: 11px; font-family: 'JetBrains Mono', monospace; color: var(--text2); padding: 3px 0; border-bottom: 1px solid var(--border); }
  .modal-point-row:last-child { border-bottom: none; }
  .modal-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  .mbtn { padding: 12px; font-size: 13px; border-radius: 10px; cursor: pointer; font-family: 'Noto Sans KR', sans-serif; font-weight: 700; border: none; }
  .mbtn-close { background: var(--surface2); color: var(--text2); }
  .mbtn-new { background: var(--accent); color: #0a0f1a; }

  .kk-marker-gps { width: 28px; height: 28px; border-radius: 50%; background: #00d4aa; border: 2px solid white; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 900; color: #0a0f1a; box-shadow: 0 2px 8px rgba(0,0,0,0.4); font-family: 'Noto Sans KR', sans-serif; }
  .kk-marker-touch { width: 28px; height: 28px; border-radius: 50%; background: #f59e0b; border: 2px solid white; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 900; color: #0a0f1a; box-shadow: 0 2px 8px rgba(0,0,0,0.4); font-family: 'Noto Sans KR', sans-serif; }
  .kk-myloc { width: 16px; height: 16px; border-radius: 50%; background: rgba(59,130,246,0.9); border: 2px solid white; box-shadow: 0 0 0 4px rgba(59,130,246,0.3); }
</style>
</head>
<body>
<div id="app">
  <header>
    <div class="logo">ì¸¡ëŸ‰<span>GPS</span></div>
    <div id="search-wrap">
      <input id="search-input" type="text" placeholder="ì£¼ì†Œ ë˜ëŠ” ì§€ëª… ê²€ìƒ‰" autocomplete="off">
      <button id="search-btn">ê²€ìƒ‰</button>
    </div>
    <div id="gps-status">
      <div class="dot" id="gps-dot"></div>
      <span id="gps-text">ëŒ€ê¸°ì¤‘</span>
    </div>
  </header>

  <div id="search-results"></div>

  <div id="map">
    <div id="kakao-map"></div>

    <!-- ëª¨ë“œ ì „í™˜ -->
    <div id="mode-bar">
      <button class="mode-btn active" id="mode-gps">ğŸ“ GPS ì°ê¸°</button>
      <button class="mode-btn" id="mode-touch">ğŸ‘† í„°ì¹˜ ì°ê¸°</button>
    </div>

    <!-- í†µê³„ -->
    <div id="stats-overlay">
      <div class="stat-chip">
        <div class="lbl">ì°ì€ ì </div>
        <div class="val"><span id="stat-points">0</span> ê°œ</div>
      </div>
      <div class="stat-chip" id="chip-dist" style="display:none">
        <div class="lbl">ì „ì²´ ë‘˜ë ˆ</div>
        <div class="val"><span id="stat-dist">-</span> m</div>
      </div>
      <div class="stat-chip" id="chip-area" style="display:none">
        <div class="lbl">ë©´ì </div>
        <div class="val"><span id="stat-area">-</span> ã¡</div>
        <div class="val"><span id="stat-pyeong">-</span> í‰</div>
      </div>
    </div>

    <!-- ì§€ë„ ì»¨íŠ¸ë¡¤ -->
    <div id="map-controls">
      <button class="map-btn on" id="layer-toggle">ğŸ—º ì§€ì ë„ ON</button>
      <button class="map-btn" id="btn-myloc">ğŸ“ ë‚´ìœ„ì¹˜</button>
    </div>

    <!-- ì¤Œ ë²„íŠ¼ -->
    <div id="zoom-controls">
      <button class="zoom-btn" id="btn-zoom-in">+</button>
      <button class="zoom-btn" id="btn-zoom-out">âˆ’</button>
    </div>

    <!-- GPS ëª¨ë“œ FAB -->
    <button id="fab-gps" disabled>ğŸ“ í˜„ì¬ ìœ„ì¹˜ ì°ê¸°</button>
    <!-- í„°ì¹˜ ëª¨ë“œ ì•ˆë‚´ -->
    <div id="touch-hint">ğŸ‘† ì§€ë„ë¥¼ í„°ì¹˜í•´ì„œ ì ì„ ì°ìœ¼ì„¸ìš”</div>
  </div>

  <div id="bottom-panel">
    <button id="panel-toggle">â–² ë„êµ¬ ë©”ë‰´ ì—´ê¸°</button>
    <div id="panel-content">
      <div class="btn-row">
        <button class="act" id="btn-calc">ğŸ“ ë©´ì /ê¸¸ì´ ê³„ì‚°</button>
        <button class="act" id="btn-undo">â†© ë§ˆì§€ë§‰ ì‚­ì œ</button>
      </div>
      <div class="btn-row">
        <button class="act" id="btn-reset">ğŸ—‘ ì „ì²´ ì´ˆê¸°í™”</button>
      </div>
      <div id="points-scroll"></div>
    </div>
  </div>
</div>

<div id="toast"></div>
<div id="result-modal">
  <div class="modal-box">
    <div class="modal-title">ğŸ“ ì¸¡ëŸ‰ ê²°ê³¼</div>
    <div class="modal-area" id="modal-area-val"></div>
    <div class="modal-sub" id="modal-pyeong-val"></div>
    <div class="modal-dist" id="modal-dist-val"></div>
    <div class="modal-points" id="modal-points-list"></div>
    <div class="modal-btns">
      <button class="mbtn mbtn-close" id="modal-close-btn">ë‹«ê¸°</button>
      <button class="mbtn mbtn-new" id="modal-new-btn">ìƒˆ ì¸¡ëŸ‰</button>
    </div>
  </div>
</div>

<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=a0cab92073d5170cb2b260df96cc5d53&libraries=services&autoload=false"></script>
<script>
kakao.maps.load(function() {
  var map, geocoder;
  var points = [], currentPos = null, panelOpen = false;
  var cadastralOn = true, myLocOverlay = null;
  var shapePolyline = null, shapePolygon = null;
  var firstFix = true;
  var currentMode = 'gps'; // 'gps' or 'touch'

  // ì§€ë„ ì´ˆê¸°í™” (ë” ë†’ì€ ì¤Œ í—ˆìš©)
  map = new kakao.maps.Map(document.getElementById('kakao-map'), {
    center: new kakao.maps.LatLng(36.5, 127.5),
    level: 10,
    maxLevel: 14,
    minLevel: 1  // ìµœëŒ€ í™•ëŒ€ (ë ˆë²¨ 1ì´ ê°€ì¥ í¬ê²Œ)
  });
  geocoder = new kakao.maps.services.Geocoder();
  map.addOverlayMapTypeId(kakao.maps.MapTypeId.USE_DISTRICT);

  // â”€â”€ ëª¨ë“œ ì „í™˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('mode-gps').addEventListener('click', function() {
    currentMode = 'gps';
    this.className = 'mode-btn active';
    document.getElementById('mode-touch').className = 'mode-btn';
    document.getElementById('fab-gps').style.display = '';
    document.getElementById('touch-hint').style.display = 'none';
  });

  document.getElementById('mode-touch').addEventListener('click', function() {
    currentMode = 'touch';
    this.className = 'mode-btn active';
    document.getElementById('mode-gps').className = 'mode-btn';
    document.getElementById('fab-gps').style.display = 'none';
    document.getElementById('touch-hint').style.display = 'block';
  });

  // â”€â”€ ì§€ë„ í„°ì¹˜/í´ë¦­ìœ¼ë¡œ ì  ì°ê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
    if (currentMode !== 'touch') return;
    var latlng = mouseEvent.latLng;
    var p = { lat: latlng.getLat(), lng: latlng.getLng(), acc: 0, id: points.length + 1, type: 'touch' };
    points.push(p);
    var overlay = new kakao.maps.CustomOverlay({
      position: latlng,
      content: '<div class="kk-marker-touch">' + p.id + '</div>',
      zIndex: 10, yAnchor: 0.5
    });
    overlay.setMap(map);
    p._overlay = overlay;
    redrawShape(); updateUI();
    showToast('ğŸ‘† ' + points.length + 'ë²ˆ ì  ì°ì—ˆì–´ìš”!', 'warn');
  });

  // â”€â”€ ì§€ì ë„ í† ê¸€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('layer-toggle').addEventListener('click', function() {
    cadastralOn = !cadastralOn;
    if (cadastralOn) {
      map.addOverlayMapTypeId(kakao.maps.MapTypeId.USE_DISTRICT);
      this.textContent = 'ğŸ—º ì§€ì ë„ ON'; this.className = 'map-btn on';
    } else {
      map.removeOverlayMapTypeId(kakao.maps.MapTypeId.USE_DISTRICT);
      this.textContent = 'ğŸ—º ì§€ì ë„ OFF'; this.className = 'map-btn';
    }
  });

  // â”€â”€ ì¤Œ ë²„íŠ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('btn-zoom-in').addEventListener('click', function() {
    map.setLevel(map.getLevel() - 1);
  });
  document.getElementById('btn-zoom-out').addEventListener('click', function() {
    map.setLevel(map.getLevel() + 1);
  });

  // â”€â”€ ë‚´ ìœ„ì¹˜ ë§ˆì»¤ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function updateMyLoc(lat, lng) {
    var pos = new kakao.maps.LatLng(lat, lng);
    if (!myLocOverlay) {
      myLocOverlay = new kakao.maps.CustomOverlay({
        position: pos, content: '<div class="kk-myloc"></div>',
        zIndex: 5, yAnchor: 0.5
      });
      myLocOverlay.setMap(map);
    } else {
      myLocOverlay.setPosition(pos);
    }
  }

  // â”€â”€ GPS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function startGPS() {
    var dot = document.getElementById('gps-dot');
    var txt = document.getElementById('gps-text');
    if (!navigator.geolocation) { dot.className = 'dot error'; txt.textContent = 'ë¯¸ì§€ì›'; return; }
    navigator.geolocation.watchPosition(function(pos) {
      currentPos = { lat: pos.coords.latitude, lng: pos.coords.longitude, acc: pos.coords.accuracy };
      dot.className = 'dot active';
      txt.textContent = 'Â±' + Math.round(pos.coords.accuracy) + 'm';
      document.getElementById('fab-gps').disabled = false;
      updateMyLoc(currentPos.lat, currentPos.lng);
      if (firstFix) {
        firstFix = false;
        map.setCenter(new kakao.maps.LatLng(currentPos.lat, currentPos.lng));
        map.setLevel(3);
      }
    }, function() {
      dot.className = 'dot error'; txt.textContent = 'ì˜¤ë¥˜';
    }, { enableHighAccuracy: true, maximumAge: 3000, timeout: 20000 });
  }

  document.getElementById('btn-myloc').addEventListener('click', function() {
    if (!currentPos) { showToast('GPS ì‹ í˜¸ ëŒ€ê¸°ì¤‘...', 'error'); return; }
    map.setCenter(new kakao.maps.LatLng(currentPos.lat, currentPos.lng));
    map.setLevel(2);
  });

  // â”€â”€ GPS ì°ê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('fab-gps').addEventListener('click', function() {
    if (!currentPos) { showToast('GPS ì‹ í˜¸ ëŒ€ê¸°ì¤‘...', 'error'); return; }
    var p = { lat: currentPos.lat, lng: currentPos.lng, acc: currentPos.acc, id: points.length + 1, type: 'gps' };
    points.push(p);
    var overlay = new kakao.maps.CustomOverlay({
      position: new kakao.maps.LatLng(p.lat, p.lng),
      content: '<div class="kk-marker-gps">' + p.id + '</div>',
      zIndex: 10, yAnchor: 0.5
    });
    overlay.setMap(map);
    p._overlay = overlay;
    redrawShape(); updateUI();
    showToast('ğŸ“ ' + points.length + 'ë²ˆ ì  ì €ì¥! (Â±' + Math.round(currentPos.acc) + 'm)');
  });

  // â”€â”€ ë„í˜• ê·¸ë¦¬ê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function redrawShape() {
    if (shapePolyline) { shapePolyline.setMap(null); shapePolyline = null; }
    if (shapePolygon) { shapePolygon.setMap(null); shapePolygon = null; }
    if (points.length < 2) return;
    var path = points.map(function(p) { return new kakao.maps.LatLng(p.lat, p.lng); });
    if (points.length >= 3) {
      shapePolygon = new kakao.maps.Polygon({
        path: path, strokeWeight: 2.5, strokeColor: '#00d4aa',
        strokeOpacity: 1, fillColor: '#00d4aa', fillOpacity: 0.15
      });
      shapePolygon.setMap(map);
    } else {
      shapePolyline = new kakao.maps.Polyline({
        path: path, strokeWeight: 2.5, strokeColor: '#00d4aa',
        strokeOpacity: 1, strokeStyle: 'dashed'
      });
      shapePolyline.setMap(map);
    }
  }

  // â”€â”€ ê±°ë¦¬ ê³„ì‚° (í•˜ë²„ì‚¬ì¸) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function haversine(p1, p2) {
    var R = 6371000;
    var toRad = function(d) { return d * Math.PI / 180; };
    var dLat = toRad(p2.lat - p1.lat);
    var dLng = toRad(p2.lng - p1.lng);
    var a = Math.sin(dLat/2)*Math.sin(dLat/2) +
            Math.cos(toRad(p1.lat))*Math.cos(toRad(p2.lat))*Math.sin(dLng/2)*Math.sin(dLng/2);
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }

  function calcPerimeter(pts) {
    var total = 0;
    for (var i = 0; i < pts.length; i++) {
      var j = (i + 1) % pts.length;
      total += haversine(pts[i], pts[j]);
    }
    return total;
  }

  function calcArea(pts) {
    if (pts.length < 3) return 0;
    var R = 6371000;
    var toRad = function(d) { return d * Math.PI / 180; };
    var area = 0, n = pts.length;
    for (var i = 0; i < n; i++) {
      var j = (i + 1) % n;
      var xi = toRad(pts[i].lng) * Math.cos(toRad(pts[i].lat)); var yi = toRad(pts[i].lat);
      var xj = toRad(pts[j].lng) * Math.cos(toRad(pts[j].lat)); var yj = toRad(pts[j].lat);
      area += (xi * yj - xj * yi);
    }
    return Math.abs(area / 2) * R * R;
  }

  function fmtDist(m) {
    if (m >= 1000) return (m/1000).toFixed(2) + ' km';
    return m.toFixed(1) + ' m';
  }

  // â”€â”€ ê²€ìƒ‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('search-btn').addEventListener('click', doSearch);
  document.getElementById('search-input').addEventListener('keydown', function(e) { if (e.key === 'Enter') doSearch(); });

  function doSearch() {
    var q = document.getElementById('search-input').value.trim();
    if (!q) return;
    var div = document.getElementById('search-results');
    div.innerHTML = '<div class="search-empty">ê²€ìƒ‰ì¤‘...</div>';
    div.style.display = 'block';
    var ps = new kakao.maps.services.Places();
    ps.keywordSearch(q, function(data, status) {
      if (status === kakao.maps.services.Status.OK && data.length) {
        renderResults(data);
      } else {
        geocoder.addressSearch(q, function(data2, status2) {
          if (status2 === kakao.maps.services.Status.OK && data2.length) {
            renderResults(data2.map(function(d) {
              return { place_name: d.address_name, road_address_name: '', x: d.x, y: d.y };
            }));
          } else {
            div.innerHTML = '<div class="search-empty">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
          }
        });
      }
    });
  }

  function renderResults(items) {
    var div = document.getElementById('search-results');
    div.innerHTML = items.slice(0,5).map(function(item) {
      return '<div class="search-item" data-x="' + item.x + '" data-y="' + item.y + '">'
        + '<div>' + item.place_name + '</div>'
        + '<div class="addr">' + (item.road_address_name || item.address_name || '') + '</div></div>';
    }).join('');
    div.querySelectorAll('.search-item').forEach(function(el) {
      el.addEventListener('click', function() {
        map.setCenter(new kakao.maps.LatLng(parseFloat(this.dataset.y), parseFloat(this.dataset.x)));
        map.setLevel(2);
        div.style.display = 'none';
        document.getElementById('search-input').value = '';
        document.getElementById('search-input').blur();
      });
    });
  }

  document.addEventListener('click', function(e) {
    if (!e.target.closest('#search-wrap') && !e.target.closest('#search-results'))
      document.getElementById('search-results').style.display = 'none';
  });

  // â”€â”€ ë„êµ¬ íŒ¨ë„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('panel-toggle').addEventListener('click', function() {
    panelOpen = !panelOpen;
    document.getElementById('panel-content').style.display = panelOpen ? 'block' : 'none';
    this.textContent = panelOpen ? 'â–¼ ë„êµ¬ ë©”ë‰´ ë‹«ê¸°' : 'â–² ë„êµ¬ ë©”ë‰´ ì—´ê¸°';
  });

  document.getElementById('btn-calc').addEventListener('click', function() {
    if (points.length < 2) { showToast('ìµœì†Œ 2ê°œ ì ì´ í•„ìš”í•©ë‹ˆë‹¤', 'error'); return; }
    var area = points.length >= 3 ? calcArea(points) : 0;
    var peri = points.length >= 3 ? calcPerimeter(points) : haversine(points[0], points[1]);
    showResult(area, peri);
  });

  document.getElementById('btn-undo').addEventListener('click', function() {
    if (!points.length) return;
    var last = points.pop();
    if (last._overlay) last._overlay.setMap(null);
    redrawShape(); updateUI(); showToast('ë§ˆì§€ë§‰ ì  ì‚­ì œë¨');
  });

  document.getElementById('btn-reset').addEventListener('click', function() {
    if (!points.length) return;
    if (confirm('ëª¨ë“  ì¸¡ëŸ‰ ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”?')) resetAll();
  });

  document.getElementById('modal-close-btn').addEventListener('click', closeModal);
  document.getElementById('modal-new-btn').addEventListener('click', resetAll);

  function resetAll() {
    points.forEach(function(p) { if (p._overlay) p._overlay.setMap(null); });
    if (shapePolyline) { shapePolyline.setMap(null); shapePolyline = null; }
    if (shapePolygon) { shapePolygon.setMap(null); shapePolygon = null; }
    points = []; updateUI(); closeModal(); showToast('ì´ˆê¸°í™” ì™„ë£Œ');
  }

  // â”€â”€ UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function updateUI() {
    document.getElementById('stat-points').textContent = points.length;
    var chipArea = document.getElementById('chip-area');
    var chipDist = document.getElementById('chip-dist');

    if (points.length >= 2) {
      var peri = points.length >= 3 ? calcPerimeter(points) : haversine(points[0], points[1]);
      document.getElementById('stat-dist').textContent = fmtDist(peri);
      chipDist.style.display = 'block';
    } else {
      chipDist.style.display = 'none';
    }

    if (points.length >= 3) {
      var area = calcArea(points);
      document.getElementById('stat-area').textContent = area.toFixed(1);
      document.getElementById('stat-pyeong').textContent = (area / 3.305785).toFixed(1);
      chipArea.style.display = 'block';
    } else {
      chipArea.style.display = 'none';
    }

    var scroll = document.getElementById('points-scroll');
    scroll.innerHTML = points.map(function(p) {
      var cls = p.type === 'touch' ? 'touch' : 'gps';
      var icon = p.type === 'touch' ? 'ğŸ‘†' : 'ğŸ“';
      return '<div class="point-item">'
        + '<div class="point-num ' + cls + '">' + p.id + '</div>'
        + '<span>' + icon + ' ' + p.lat.toFixed(6) + ', ' + p.lng.toFixed(6) + '</span>'
        + (p.acc > 0 ? '<span style="margin-left:auto;font-size:10px">Â±' + Math.round(p.acc) + 'm</span>' : '')
        + '</div>';
    }).join('');
    scroll.scrollTop = scroll.scrollHeight;
  }

  function showResult(area, peri) {
    var pyeong = area / 3.305785;
    if (area > 0) {
      document.getElementById('modal-area-val').textContent = area.toFixed(2) + ' ã¡';
      document.getElementById('modal-pyeong-val').textContent = pyeong.toFixed(2) + ' í‰';
    } else {
      document.getElementById('modal-area-val').textContent = 'ì„  ì¸¡ëŸ‰';
      document.getElementById('modal-pyeong-val').textContent = '(ì  3ê°œ ì´ìƒì´ë©´ ë©´ì  ê³„ì‚°)';
    }
    document.getElementById('modal-dist-val').textContent = 'ë‘˜ë ˆ/ê±°ë¦¬: ' + fmtDist(peri);
    document.getElementById('modal-points-list').innerHTML =
      points.map(function(p) {
        var icon = p.type === 'touch' ? 'ğŸ‘†' : 'ğŸ“';
        return '<div class="modal-point-row">' + icon + ' P' + p.id + ': ' + p.lat.toFixed(7) + ', ' + p.lng.toFixed(7) + '</div>';
      }).join('');
    document.getElementById('result-modal').classList.add('show');
  }

  function closeModal() { document.getElementById('result-modal').classList.remove('show'); }

  var toastTimer;
  function showToast(msg, type) {
    var t = document.getElementById('toast');
    t.textContent = msg;
    t.className = 'show' + (type ? ' ' + type : '');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(function() { t.className = ''; }, 2500);
  }

  startGPS();
});
</script>
</body>
</html>
